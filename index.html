<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krishi Rakshak</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; background-image: linear-gradient(to top, #f0fdf4 0%, #e6f7f0 100%); }
        .app-container { width: 100%; max-width: 420px; min-height: 800px; border: 4px solid #4ade80; }
        @media (min-width: 768px) { .app-container { max-width: 1000px; } .main-content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; } }
        .nav-item.active { color: #16a34a; border-bottom: 2px solid #16a34a; }
        .page { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pump-mode-btn.active { background-color: #16a34a; color: white; }
        .modal-overlay { animation: fadeIn 0.2s ease-out; }
        .modal-content { animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .mic-listening i { color: #ef4444 !important; } /* Red color for mic icon when listening */
        @keyframes antennaPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .antenna-tip { animation: antennaPulse 2s infinite ease-in-out; transform-origin: center; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="app-container bg-white rounded-3xl shadow-2xl mx-auto my-8 overflow-hidden relative">
        <main id="main-content" class="p-6 pb-24 h-full">
            
            <!-- Page 1: Dashboard -->
            <div id="dashboard-page" class="page">
                <div class="flex justify-between items-center mb-6">
                    <div><h1 class="text-2xl font-bold text-gray-800">Krishi Rakshak</h1><p class="text-gray-500">Welcome back, Farmer!</p></div>
                    <div id="profile-button" class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center cursor-pointer hover:bg-green-200 transition"><i class="fas fa-user text-green-600"></i></div>
                </div>
                <div class="main-content-grid">
                    <div>
                        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-5 rounded-2xl mb-6 shadow-lg">
                            <div class="flex justify-between items-start">
                                <div><p class="text-lg font-semibold">Gharuan, Kharar</p><p class="text-sm opacity-90">Sunny</p></div>
                                <div class="text-right"><p class="text-4xl font-bold">32°C</p></div>
                            </div>
                        </div>
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">Government Schemes & News</h3>
                            <div class="h-48 overflow-y-auto bg-gray-50 p-3 rounded-xl border border-gray-200 space-y-3">
                                <div class="bg-white p-3 rounded-lg shadow-sm"><h4 class="font-bold text-green-800">PM Kisan Samman Nidhi</h4><p class="text-sm text-gray-600 mt-1">Financial support of ₹6,000 per year for small and marginal farmers.</p></div>
                                <div class="bg-white p-3 rounded-lg shadow-sm"><h4 class="font-bold text-green-800">Pradhan Mantri Fasal Bima Yojana</h4><p class="text-sm text-gray-600 mt-1">Insurance coverage against crop failure due to calamities, pests or diseases.</p></div>
                            </div>
                             <button id="scheme-helper-button" class="mt-3 w-full bg-gradient-to-r from-blue-500 to-sky-600 text-white py-2 px-4 rounded-lg font-semibold hover:opacity-90 transition-opacity text-sm">✨ Ask AI Helper about Schemes</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Quick Actions</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div id="diagnose-button" class="action-card bg-green-50 p-4 rounded-xl text-center cursor-pointer hover:bg-green-100 transition"><i class="fas fa-leaf text-3xl text-green-600 mb-2"></i><p>Diagnose</p></div>
                            <div id="irrigation-button" class="action-card bg-blue-50 p-4 rounded-xl text-center cursor-pointer hover:bg-blue-100 transition"><i class="fas fa-tint text-3xl text-blue-600 mb-2"></i><p>Irrigation</p></div>
                            <div id="market-analysis-button" class="action-card bg-yellow-50 p-4 rounded-xl text-center cursor-pointer hover:bg-yellow-100 transition"><i class="fas fa-chart-line text-3xl text-yellow-600 mb-2"></i><p>Market Analysis</p></div>
                            <div id="kendra-button" class="action-card bg-purple-50 p-4 rounded-xl text-center cursor-pointer hover:bg-purple-100 transition"><i class="fas fa-map-marker-alt text-3xl text-purple-600 mb-2"></i><p>Krishi Kendra</p></div>
                            <div id="ai-chat-button" class="action-card col-span-2 bg-indigo-50 p-4 rounded-xl text-center cursor-pointer hover:bg-indigo-100 transition"><i class="fas fa-comments text-3xl text-indigo-600 mb-2"></i><p class="font-semibold text-gray-700">Krishi Mitr (AI Assistant)</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 2: Diagnose -->
            <div id="diagnose-page" class="page hidden">
                 <div class="flex items-center mb-6"><button class="back-button text-gray-600 hover:text-green-600"><i class="fas fa-arrow-left mr-2"></i>Back</button></div>
                <div id="diagnose-upload" class="text-center">
                    <h2 class="text-xl font-semibold mb-2">Advanced Crop Analysis</h2>
                    <p class="text-gray-600 mb-6">Upload an image for analysis. For multispectral images, please upload a pre-processed false-color composite.</p>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 mb-4"><svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-400"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg><p class="text-gray-500 mt-2">Tap to upload image file</p></div>
                    <input type="file" id="leaf-image-input" class="hidden" accept="image/*">
                    <button id="upload-button" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700 transition-colors">Select Image File</button>
                </div>
                <div id="diagnose-loading" class="hidden text-center"><div class="flex flex-col items-center justify-center pt-16"><div class="w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full animate-spin"></div><p class="mt-4 text-gray-600">Analyzing Image with AI...</p></div></div>
                <div id="diagnose-result" class="hidden text-left">
                    <h2 class="text-xl font-semibold mb-4">Analysis Result</h2>
                    <img id="result-image" src="https://placehold.co/400x300/e2e8f0/cbd5e0?text=Your+Image" alt="Uploaded leaf" class="rounded-lg mb-4 w-full">
                    <div class="bg-gray-50 p-4 rounded-lg space-y-4">
                        <div><p class="font-semibold text-gray-800">Detected Condition:</p><p id="disease-name" class="text-lg text-red-600 font-bold"></p></div>
                        <div><p class="font-semibold text-gray-800">Confidence:</p><p id="confidence-score" class="text-green-700"></p></div>
                    </div>
                     <button id="gemini-insights-button" class="mt-4 w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:opacity-90 transition-opacity">✨ Get Deeper Insights with AI</button>
                     <button id="diagnose-again-button" class="mt-2 w-full bg-gray-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-gray-700 transition-colors">Analyze Another</button>
                </div>
            </div>

            <!-- Page 3: Irrigation -->
            <div id="irrigation-page" class="page hidden">
                 <div class="flex items-center mb-6"><button class="back-button text-gray-600 hover:text-green-600"><i class="fas fa-arrow-left mr-2"></i>Back</button></div>
                 <h2 class="text-xl font-semibold mb-6">Irrigation Control</h2>
                 <div class="bg-gray-50 p-6 rounded-2xl text-center">
                    <div class="mb-6"><p class="font-semibold mb-2">Operation Mode</p><div class="inline-flex rounded-lg shadow-sm"><button data-mode="manual" class="pump-mode-btn py-2 px-6 rounded-l-lg bg-gray-200 text-gray-700 active">Manual</button><button data-mode="auto" class="pump-mode-btn py-2 px-6 rounded-r-lg bg-gray-200 text-gray-700">Automatic</button></div></div>
                     <p class="text-gray-500 text-sm">Soil Moisture</p><p class="text-6xl font-bold text-blue-600 my-2">45%</p>
                     <div class="w-full bg-gray-200 rounded-full h-4 my-4"><div class="bg-blue-500 h-4 rounded-full" style="width: 45%;"></div></div>
                     <div class="flex justify-between items-center mt-6"><p class="font-semibold">Pump Status</p><button id="pump-toggle" class="bg-red-500 text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-red-600 transition">OFF</button></div>
                 </div>
            </div>

            <!-- Page 4: Krishi Kendra -->
            <div id="kendra-page" class="page hidden">
                <div class="flex items-center mb-6"><button class="back-button text-gray-600 hover:text-green-600"><i class="fas fa-arrow-left mr-2"></i>Back</button></div>
                <h2 class="text-xl font-semibold mb-4">Nearest Krishi Kendra</h2>
                <div id="kendra-details" class="mb-4 bg-gray-50 p-4 rounded-lg text-left hidden">
                    <h3 id="kendra-name" class="font-bold text-lg text-gray-800"></h3><p id="kendra-address" class="text-gray-600"></p>
                    <button id="get-directions-button" class="mt-3 w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Get Directions</button>
                </div>
                <div id="map" class="w-full h-80 bg-gray-200 rounded-lg flex items-center justify-center"><p id="map-placeholder" class="text-gray-500 p-4 text-center">Requesting your location...</p></div>
            </div>
            
            <!-- Page 5: Farmer Profile -->
            <div id="profile-page" class="page hidden">
                 <div class="flex items-center mb-6"><button class="back-button text-gray-600 hover:text-green-600"><i class="fas fa-arrow-left mr-2"></i>Back to Dashboard</button></div>
                <div class="text-center mb-8">
                     <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-user text-4xl text-green-600"></i></div>
                    <h2 class="text-2xl font-bold text-gray-800">Neeraj Kumar</h2><p class="text-gray-500">Gharuan, Kharar</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-yellow-50 p-4 rounded-xl"><h3 class="font-bold text-lg mb-3 text-yellow-800"><i class="fas fa-spa mr-2"></i>Soil Health</h3><div class="space-y-2 text-gray-700"><p><strong>Type:</strong> <span id="soil-type">Silty Loam</span></p><p><strong>Best Crops:</strong> <span>Maize, Wheat, Vegetables</span></p><p><strong>Current Crop:</strong> <span id="current-crop">Tomato</span></p></div><button id="gemini-plan-button" class="mt-4 w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-2 px-4 rounded-lg font-semibold hover:opacity-90 transition-opacity text-sm">✨ Generate Crop Plan with AI</button></div>
                    <div class="bg-blue-50 p-4 rounded-xl"><h3 class="font-bold text-lg mb-3 text-blue-800"><i class="fas fa-tint mr-2"></i>Irrigation Status</h3><div class="mb-3 text-center"><p class="font-semibold text-sm mb-1">Operation Mode</p><div class="inline-flex rounded-lg shadow-sm text-sm"><button data-mode="manual" class="pump-mode-btn py-1 px-4 rounded-l-lg bg-gray-200 text-gray-700 active">Manual</button><button data-mode="auto" class="pump-mode-btn py-1 px-4 rounded-r-lg bg-gray-200 text-gray-700">Automatic</button></div></div><div class="text-center mb-3"><p class="text-gray-500 text-sm">Soil Moisture</p><p class="text-4xl font-bold text-blue-600">45%</p></div><div class="flex justify-between items-center"><p class="font-semibold">Pump Status</p><button id="pump-toggle-profile" class="bg-red-500 text-white font-bold py-2 px-5 rounded-full shadow-md hover:bg-red-600 transition">OFF</button></div></div>
                </div>
                <div class="mt-8"><h3 class="font-bold text-lg mb-3 text-gray-800"><i class="fas fa-history mr-2"></i>Recent Scans</h3>
                    <div id="recent-scans-list" class="space-y-3">
                        <div class="flex items-center bg-gray-50 p-3 rounded-lg"><img src="https://placehold.co/60x60/e2e8f0/334155?text=Scan1" class="w-14 h-14 object-cover rounded-md mr-4"><div class="flex-grow"><p class="font-semibold text-red-600">Potato Late Blight</p><p class="text-sm text-gray-500">Sep 18, 2025 - 98.2% Confidence</p></div></div>
                        <div class="flex items-center bg-gray-50 p-3 rounded-lg"><img src="https://placehold.co/60x60/e2e8f0/334155?text=Scan2" class="w-14 h-14 object-cover rounded-md mr-4"><div class="flex-grow"><p class="font-semibold text-green-700">Tomato Healthy</p><p class="text-sm text-gray-500">Sep 15, 2025 - 99.8% Confidence</p></div></div>
                        <p id="no-scans-placeholder" class="text-gray-500 text-center py-4 hidden">No new scans performed yet.</p>
                    </div>
                </div>
            </div>

            <!-- Page 6: Market Analysis -->
            <div id="market-analysis-page" class="page hidden flex flex-col h-full">
                <div class="flex items-center mb-6 flex-shrink-0"><button class="back-button text-gray-600 hover:text-green-600"><i class="fas fa-arrow-left mr-2"></i>Back</button></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex-shrink-0">Market Analysis</h2>
                <div class="space-y-4">
                    <div><label for="crop-select" class="block text-sm font-medium text-gray-700">Select Crop:</label><select id="crop-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"><option>Tomato</option><option>Wheat</option><option>Potato</option><option>Onion</option></select></div>
                    <button id="get-forecast-button" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:opacity-90 transition-opacity">✨ Get AI Price Forecast</button>
                </div>
            </div>
            
            <!-- Page 7: AI Chat Assistant Page "Krishi Mitr" -->
            <div id="chat-page" class="page hidden flex flex-col h-full">
                <div class="flex items-center mb-4 flex-shrink-0"><button class="back-button text-gray-600 hover:text-green-600"><i class="fas fa-arrow-left mr-2"></i>Back</button></div>
                <div class="flex items-center mb-4 flex-shrink-0">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-8 h-8 text-green-600" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 16L5 18C5 19.1046 5.89543 20 7 20H17C18.1046 20 19 19.1046 19 18V16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 14V16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 11H9C7.89543 11 7 10.1046 7 9V9C7 7.89543 7.89543 7 9 7H15C16.1046 7 17 7.89543 17 9V9C17 10.1046 16.1046 11 15 11Z" fill="currentColor" fill-opacity="0.2" stroke="currentColor" stroke-width="2"/><path d="M9 7V5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle class="antenna-tip" cx="12" cy="1.5" r="1.5" fill="#34D399"/></svg>
                    </div>
                    <div><h2 class="text-xl font-bold text-gray-800">Krishi Mitr</h2><p class="text-sm text-gray-500">Your personal farming assistant</p></div>
                </div>
                <div id="chat-messages" class="flex-grow overflow-y-auto bg-gray-50 p-4 rounded-lg space-y-4">
                    <div class="flex"><div class="bg-green-100 text-green-800 p-3 rounded-lg max-w-xs"><p>Namaste! How can I help you with your farming questions today? You can type or use the microphone to talk.</p></div></div>
                </div>
                <div class="mt-4 flex-shrink-0 flex items-center">
                    <input type="text" id="chat-input" placeholder="Ask about crops, soil, schemes..." class="flex-grow border-gray-300 rounded-l-lg shadow-sm focus:ring-green-500 focus:border-green-500">
                    <button id="chat-mic-button" class="bg-gray-200 text-gray-600 px-4 py-2 hover:bg-gray-300"><i class="fas fa-microphone"></i></button>
                    <button id="chat-send-button" class="bg-green-600 text-white px-4 py-2 rounded-r-lg font-semibold hover:bg-green-700"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>

        </main>
        <nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-[420px] bg-white border-t border-gray-200 flex justify-around md:rounded-b-3xl">
             <button data-page="dashboard-page" class="nav-item flex-1 py-4 text-center text-gray-500 hover:text-green-600 transition active"><i class="fas fa-home"></i><span class="block text-xs">Home</span></button>
            <button data-page="diagnose-page" class="nav-item flex-1 py-4 text-center text-gray-500 hover:text-green-600 transition"><i class="fas fa-leaf"></i><span class="block text-xs">Diagnose</span></button>
            <button data-page="irrigation-page" class="nav-item flex-1 py-4 text-center text-gray-500 hover:text-green-600 transition"><i class="fas fa-tint"></i><span class="block text-xs">Irrigation</span></button>
            <button data-page="kendra-page" class="nav-item flex-1 py-4 text-center text-gray-500 hover:text-green-600 transition"><i class="fas fa-map-marker-alt"></i><span class="block text-xs">Kendra</span></button>
        </nav>
    </div>
    <!-- Modals -->
    <div id="gemini-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b"><h3 id="modal-title" class="text-lg font-bold text-gray-800"></h3><button id="close-modal-button" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div>
            <div class="p-6 overflow-y-auto"><div id="modal-spinner" class="flex flex-col items-center justify-center py-10"><div class="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full animate-spin"></div><p class="mt-4 text-gray-600">Generating response...</p></div><div id="modal-content-area" class="text-gray-700 space-y-4"></div></div>
        </div>
    </div>
    <div id="scheme-helper-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay">
         <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b"><h3 class="text-lg font-bold text-gray-800">✨ AI Scheme Helper</h3><button id="close-scheme-modal-button" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div>
            <div class="p-6 overflow-y-auto flex-grow flex flex-col"><div id="scheme-response-area" class="text-gray-700 space-y-2 flex-grow h-64 overflow-y-auto mb-4 bg-gray-50 p-3 rounded-md"><p>Hello! How can I help you with government schemes today?</p></div><div id="scheme-spinner" class="hidden flex items-center justify-center py-2"><div class="w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div></div><div class="flex space-x-2"><input type="text" id="scheme-question-input" placeholder="e.g., Am I eligible for PM Kisan?" class="flex-grow border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 rounded-md shadow-sm"><button id="ask-scheme-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700"><i class="fas fa-paper-plane"></i></button></div></div>
        </div>
    </div>

    <script>
        function initApp() {
            // Reusable Gemini API Function
            async function callGemini(prompt) {
                try {
                    const response = await fetch('/api/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });
                    if (!response.ok) return "Sorry, AI server error.";
                    const result = await response.json();
                    return result.response;
                } catch (error) {
                    return "Sorry, could not connect to AI service.";
                }
            }
            
            // --- Page Navigation & UI Logic ---
            const pages = document.querySelectorAll('.page');
            const navItems = document.querySelectorAll('.nav-item');
            const backButtons = document.querySelectorAll('.back-button');
            const profileButton = document.getElementById('profile-button');

            function showPage(pageId) {
                pages.forEach(p => p.classList.add('hidden'));
                const target = document.getElementById(pageId);
                if(target) target.classList.remove('hidden');
                
                navItems.forEach(item => {
                    item.classList.toggle('active', item.dataset.page === pageId);
                });
                if (pageId === 'kendra-page') {
                    handleLocationAccess();
                }
            }
            
            navItems.forEach(item => item.addEventListener('click', () => showPage(item.dataset.page)));
            backButtons.forEach(b => b.addEventListener('click', () => showPage('dashboard-page')));
            document.getElementById('diagnose-button').addEventListener('click', () => showPage('diagnose-page'));
            document.getElementById('irrigation-button').addEventListener('click', () => showPage('irrigation-page'));
            document.getElementById('market-analysis-button').addEventListener('click', () => showPage('market-analysis-page'));
            document.getElementById('kendra-button').addEventListener('click', () => showPage('kendra-page'));
            document.getElementById('profile-button').addEventListener('click', () => showPage('profile-page'));
            document.getElementById('ai-chat-button').addEventListener('click', () => showPage('chat-page'));
            
            // --- Diagnosis Logic ---
            const uploadButton = document.getElementById('upload-button');
            const fileInput = document.getElementById('leaf-image-input');
            const diagnoseUpload = document.getElementById('diagnose-upload');
            const diagnoseLoading = document.getElementById('diagnose-loading');
            const diagnoseResult = document.getElementById('diagnose-result');
            const resultImage = document.getElementById('result-image');
            const diagnoseAgainButton = document.getElementById('diagnose-again-button');
            const scansList = document.getElementById('recent-scans-list');
            const noScansPlaceholder = document.getElementById('no-scans-placeholder');
            const diseaseNameEl = document.getElementById('disease-name');
            const confidenceScoreEl = document.getElementById('confidence-score');
            const secondaryModelURL = "https://teachablemachine.withgoogle.com/models/D5g-632k7/";
            let model; 

            async function loadSecondaryModel() {
                if (model) return model;
                try {
                    model = await tmImage.load(secondaryModelURL + "model.json", secondaryModelURL + "metadata.json");
                    return model;
                } catch (error) { console.error("Failed to load secondary model:", error); return null; }
            }
            loadSecondaryModel(); 

            uploadButton.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (event) => {
                if (event.target.files && event.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = async function(e) { 
                        resultImage.src = e.target.result; 
                        diagnoseUpload.classList.add('hidden');
                        diagnoseLoading.classList.remove('hidden');
                        diagnoseResult.classList.add('hidden');
                        const loadedModel = await loadSecondaryModel();
                        if (!loadedModel) {
                            diseaseNameEl.textContent = "Error: AI Model could not be loaded.";
                            diagnoseLoading.classList.add('hidden');
                            diagnoseResult.classList.remove('hidden');
                            return;
                        }
                        try {
                            const prediction = await loadedModel.predict(resultImage);
                            let highestPrediction = prediction.reduce((prev, current) => (prev.probability > current.probability) ? prev : current);
                            const formattedClassName = highestPrediction.className.replace(/_/g, " ");
                            const formattedConfidence = (highestPrediction.probability * 100).toFixed(1) + "%";
                            diseaseNameEl.textContent = formattedClassName;
                            confidenceScoreEl.textContent = formattedConfidence;
                            diseaseNameEl.classList.toggle('text-red-600', !formattedClassName.toLowerCase().includes('healthy'));
                            diseaseNameEl.classList.toggle('text-green-700', formattedClassName.toLowerCase().includes('healthy'));
                            addScanToProfile(e.target.result, formattedClassName, formattedConfidence);
                        } catch (error) { diseaseNameEl.textContent = "Error during analysis";
                        } finally {
                            diagnoseLoading.classList.add('hidden');
                            diagnoseResult.classList.remove('hidden');
                        }
                    }
                    reader.readAsDataURL(event.target.files[0]);
                }
            });
            function addScanToProfile(imageSrc, disease, confidence) {
                if(noScansPlaceholder) noScansPlaceholder.style.display = 'none';
                const date = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const isHealthy = disease.toLowerCase().includes('healthy');
                const colorClass = isHealthy ? 'text-green-700' : 'text-red-600';
                const newScanHTML = `<div class="flex items-center bg-gray-50 p-3 rounded-lg"><img src="${imageSrc}" class="w-14 h-14 object-cover rounded-md mr-4"><div class="flex-grow"><p class="font-semibold ${colorClass}">${disease}</p><p class="text-sm text-gray-500">${date} - ${confidence} Confidence</p></div></div>`;
                scansList.insertAdjacentHTML('afterbegin', newScanHTML);
            }
            diagnoseAgainButton.addEventListener('click', () => {
                diagnoseResult.classList.add('hidden');
                diagnoseUpload.classList.remove('hidden');
                fileInput.value = '';
            });

            // --- Krishi Mitr - AI Chat Assistant Logic ---
            const chatInput = document.getElementById('chat-input');
            const chatSendButton = document.getElementById('chat-send-button');
            const chatMicButton = document.getElementById('chat-mic-button');
            const chatMessages = document.getElementById('chat-messages');
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'hi-IN'; // Listen for Hindi
                recognition.interimResults = false;
                recognition.onstart = () => chatMicButton.classList.add('mic-listening');
                recognition.onend = () => chatMicButton.classList.remove('mic-listening');
                recognition.onresult = (event) => {
                    chatInput.value = event.results[0][0].transcript;
                    handleSendMessage();
                };
                recognition.onerror = (event) => { console.error('Speech recognition error:', event.error); chatMicButton.classList.remove('mic-listening'); };
                chatMicButton.addEventListener('click', () => recognition.start());
            } else { chatMicButton.style.display = 'none'; }
            
            chatSendButton.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSendMessage(); });

            async function handleSendMessage() {
                const userMessage = chatInput.value.trim();
                if (!userMessage) return;
                appendMessage(userMessage, 'user');
                chatInput.value = '';
                appendMessage('...', 'ai', true);
                const prompt = `You are Krishi Mitr, an agricultural AI assistant. A farmer asked in Hindi: "${userMessage}". Provide a helpful and concise answer in simple Hindi.`;
                const aiResponse = await callGemini(prompt);
                removeTypingIndicator();
                appendMessage(aiResponse, 'ai');
            }

            function appendMessage(message, sender, isTyping = false) {
                const wrapper = document.createElement('div');
                const bubble = document.createElement('div');
                wrapper.classList.add('flex');
                bubble.innerHTML = `<p>${message}</p>`;
                if (sender === 'user') {
                    wrapper.classList.add('justify-end');
                    bubble.classList.add('bg-blue-500', 'text-white', 'p-3', 'rounded-lg', 'max-w-xs');
                } else {
                    bubble.classList.add('bg-green-100', 'text-green-800', 'p-3', 'rounded-lg', 'max-w-xs');
                    if (isTyping) {
                        bubble.id = 'typing-indicator';
                        bubble.innerHTML = `<div class="flex items-center space-x-1"><div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-green-400 rounded-full animate-pulse [animation-delay:0.2s]"></div><div class="w-2 h-2 bg-green-400 rounded-full animate-pulse [animation-delay:0.4s]"></div></div>`;
                    } else { speak(message.replace(/<[^>]*>/g, '')); }
                }
                wrapper.appendChild(bubble);
                chatMessages.appendChild(wrapper);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function speak(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'hi-IN'; // Speak in Hindi
                    window.speechSynthesis.speak(utterance);
                }
            }

            function removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.parentElement.remove();
            }

            // --- Other feature logic ---
            const geminiModal = document.getElementById('gemini-modal');
            const closeModalButton = document.getElementById('close-modal-button');
            const modalTitle = document.getElementById('modal-title');
            const modalSpinner = document.getElementById('modal-spinner');
            const modalContentArea = document.getElementById('modal-content-area');
            const schemeHelperModal = document.getElementById('scheme-helper-modal');
            const closeSchemeModalButton = document.getElementById('close-scheme-modal-button');
            const allPumpToggleButtons = document.querySelectorAll('[id^="pump-toggle"]');
            const allPumpModeButtons = document.querySelectorAll('.pump-mode-btn');

            function showModal(title) {
                modalTitle.textContent = title;
                modalContentArea.innerHTML = '';
                modalSpinner.classList.remove('hidden');
                geminiModal.classList.remove('hidden');
            }
            closeModalButton.addEventListener('click', () => geminiModal.classList.add('hidden'));
            document.getElementById('gemini-insights-button').addEventListener('click', async () => {
                const disease = diseaseNameEl.textContent;
                showModal(`✨ AI Insights for ${disease}`);
                const prompt = `You are an agricultural expert. A farmer's plant is diagnosed with ${disease}. Provide a detailed explanation covering symptoms, organic remedies, chemical treatments, and preventive measures.`;
                const result = await callGemini(prompt);
                modalContentArea.innerHTML = result;
                modalSpinner.classList.add('hidden');
            });
            document.getElementById('get-forecast-button').addEventListener('click', async () => {
                const crop = document.getElementById('crop-select').value;
                showModal(`✨ AI Price Forecast for ${crop}`);
                const prompt = `You are an expert agricultural market analyst for the Kharar, Punjab, India region. Provide a simple, one-paragraph price forecast for ${crop} for the next two weeks.`;
                const result = await callGemini(prompt);
                modalContentArea.innerHTML = result;
                modalSpinner.classList.add('hidden');
            });
            document.getElementById('gemini-plan-button').addEventListener('click', async () => {
                 const soil = document.getElementById('soil-type').textContent;
                 const crop = document.getElementById('current-crop').textContent;
                 showModal(`✨ AI Crop Plan for ${crop}`);
                 const prompt = `You are an expert agronomist. A farmer in Kharar, India, with ${soil} soil is growing ${crop}. Generate a simple, 4-week action plan covering watering, fertilization, and pest monitoring.`;
                 const result = await callGemini(prompt);
                 modalContentArea.innerHTML = result;
                 modalSpinner.classList.add('hidden');
            });
            document.getElementById('scheme-helper-button').addEventListener('click', () => schemeHelperModal.classList.remove('hidden'));
            closeSchemeModalButton.addEventListener('click', () => schemeHelperModal.classList.add('hidden'));
            document.getElementById('ask-scheme-button').addEventListener('click', async () => { 
                const schemeSpinner = document.getElementById('scheme-spinner');
                const schemeQuestionInput = document.getElementById('scheme-question-input');
                const schemeResponseArea = document.getElementById('scheme-response-area');
                const question = schemeQuestionInput.value;
                if (!question) return;
                
                schemeResponseArea.innerHTML += `<p class="text-right text-blue-600 font-semibold">${question}</p>`;
                schemeQuestionInput.value = '';
                schemeSpinner.classList.remove('hidden');

                const prompt = `You are a helpful AI assistant for Indian farmers, knowledgeable about government schemes like PM Kisan, Fasal Bima Yojana, and KCC. A farmer asked: "${question}". Provide a simple, clear, and helpful answer in plain language.`;
                const result = await callGemini(prompt);
                
                schemeResponseArea.innerHTML += `<p class="text-left text-gray-800">${result}</p>`;
                schemeSpinner.classList.add('hidden');
                schemeResponseArea.scrollTop = schemeResponseArea.scrollHeight;
             });

            function setPumpState(button) {
                const isOn = button.textContent === 'ON';
                const newText = isOn ? 'OFF' : 'ON';
                allPumpToggleButtons.forEach(btn => {
                    btn.textContent = newText;
                    btn.classList.toggle('bg-green-500', !isOn);
                    btn.classList.toggle('bg-red-500', isOn);
                });
            }
             function setPumpMode(selectedMode) {
                 allPumpModeButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === selectedMode);
                 });
                 allPumpToggleButtons.forEach(btn => {
                    btn.disabled = selectedMode === 'auto';
                    btn.classList.toggle('opacity-50', selectedMode === 'auto');
                    btn.classList.toggle('cursor-not-allowed', selectedMode === 'auto');
                 });
            }
            allPumpToggleButtons.forEach(btn => btn.addEventListener('click', (e) => setPumpState(e.target)));
            allPumpModeButtons.forEach(btn => btn.addEventListener('click', (e) => setPumpMode(e.target.dataset.mode)));
            
            // --- Krishi Kendra Logic ---
            const kendraDetails = document.getElementById('kendra-details');
            let userCurrentLocation = null;
            const krishiKendras = [
                { name: "Krishi Vigyan Kendra, SAS Nagar (Mohali)", lat: 30.6405, lng: 76.7237, address: "Sector 62, SAS Nagar, Punjab" },
                { name: "Punjab Agricultural University, Ludhiana", lat: 30.9010, lng: 75.8573, address: "Ferozepur Road, Ludhiana, Punjab" },
            ];
            function findNearestKendra(userLat, userLng) {
                return krishiKendras.reduce((prev, curr) => {
                    const prevDist = getDistance(userLat, userLng, prev.lat, prev.lng);
                    const currDist = getDistance(userLat, userLng, curr.lat, curr.lng);
                    return (prevDist < currDist) ? prev : curr;
                });
            }
            function getDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; const dLat = (lat2-lat1) * Math.PI / 180; const dLon = (lon2-lon1) * Math.PI / 180; 
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            }
            function handleLocationAccess() {
                const mapPlaceholder = document.getElementById('map-placeholder');
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userCurrentLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                            const nearestKendra = findNearestKendra(userCurrentLocation.lat, userCurrentLocation.lng);
                            if (nearestKendra) {
                                kendraDetails.classList.remove('hidden');
                                document.getElementById("kendra-name").textContent = nearestKendra.name;
                                document.getElementById("kendra-address").textContent = nearestKendra.address;
                                document.getElementById('get-directions-button').onclick = () => {
                                    window.open(`https://www.google.com/maps/dir/?api=1&origin=${userCurrentLocation.lat},${userCurrentLocation.lng}&destination=${nearestKendra.lat},${nearestKendra.lng}`, '_blank');
                                };
                                initMap(userCurrentLocation, nearestKendra);
                            } else { mapPlaceholder.textContent = "Could not find any Krishi Kendras near you."; }
                        },
                        (error) => { mapPlaceholder.textContent = "Location access denied. Please enable it to use this feature."; }
                    );
                } else { mapPlaceholder.textContent = "Geolocation is not supported by your browser."; }
            }
            function initMap(userLocation, nearestKendra) {
                const map = new google.maps.Map(document.getElementById("map"), { zoom: 10, center: userLocation });
                new google.maps.Marker({ position: userLocation, map, title: "Your Location" });
                new google.maps.Marker({ position: nearestKendra, map, title: nearestKendra.name });
            }
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initApp" async defer></script>
</body>
</html>

